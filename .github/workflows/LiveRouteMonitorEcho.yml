name: âœ¨ LiveRouteMonitorEcho

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # 6am UTC daily

jobs:
  monitor-routes:
    runs-on: ubuntu-latest
    env:
      CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: ğŸ’¾ Checkout repo
        uses: actions/checkout@v3

      - name: âœ¨ Diff Cloudflare Live Ruleset vs JSON
        id: diff
        run: |
          curl -s -X GET \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/rulesets | jq . > live_rules.json

          diff cloudflare_redirects_config.json live_rules.json > diff_output.txt || true

      - name: ğŸ“ Log Differences to GitHub Issue (if any)
        if: success()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: ğŸ”§ Cloudflare Redirect Drift Detected
          content-filepath: diff_output.txt
          labels: monitoring, redirect-drift

      - name: ğŸ’¾ Save Snapshot with SHA Anchor
        run: |
          timestamp=$(date +"%Y-%m-%d--%H-%M-%S")
          sha=$(sha512sum cloudflare_redirects_config.json | cut -d ' ' -f1)
          echo "SHA512: $sha" > vaulttrace-$timestamp.md
          echo "Timestamp: $timestamp" >> vaulttrace-$timestamp.md
          echo "Capsule: VaultEcho Cloudflare Routes" >> vaulttrace-$timestamp.md
          mv vaulttrace-$timestamp.md ./VaultEcho/

      - name: ğŸ“‹ Commit VaultEcho Anchor Log
        run: |
          git config user.name "VaultEcho Bot"
          git config user.email "bot@averyos.com"
          git add VaultEcho/
          git commit -m "ğŸ“Š VaultEcho snapshot @ $timestamp"
          git push

      - name: ğŸ› ï¸ Wrangler Fallback Deploy (Optional)
        run: |
          npm install -g wrangler
          wrangler login --api-token $CF_API_TOKEN
          wrangler publish || echo "Wrangler fallback skipped (optional)"
        continue-on-error: true
