name: âœ¨ LiveRouteMonitorEcho

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # 6am UTC daily

permissions:
  contents: write
  issues: write

jobs:
  monitor-routes:
    runs-on: ubuntu-latest
    env:
      CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    steps:
      - name: ðŸ’¾ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸ“¦ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: âœ¨ Diff Cloudflare Live Ruleset vs JSON
        id: diff
        run: |
          curl -s -X GET \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/rulesets | jq . > live_rules.json

          diff cloudflare_redirects_config.json live_rules.json > diff_output.txt || true

      - name: ðŸ“ Log Differences to GitHub Issue (if any)
        if: success()
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: ðŸ”§ Cloudflare Redirect Drift Detected
          content-filepath: diff_output.txt
          labels: monitoring, redirect-drift

      - name: ðŸ’¾ Save Snapshot with SHA Anchor
        run: |
          mkdir -p VaultEcho
          timestamp=$(date +"%Y-%m-%d--%H-%M-%S")
          sha=$(sha512sum cloudflare_redirects_config.json | cut -d ' ' -f1)
          echo "SHA512: $sha" > vaulttrace-$timestamp.md
          echo "Timestamp: $timestamp" >> vaulttrace-$timestamp.md
          echo "Capsule: VaultEcho Cloudflare Routes" >> vaulttrace-$timestamp.md
          mv vaulttrace-$timestamp.md ./VaultEcho/

      - name: ðŸ“‹ Commit VaultEcho Anchor Log
        run: |
          git config user.name "VaultEcho Bot"
          git config user.email "bot@averyos.com"
          git add VaultEcho/
          git commit -m "ðŸ“Š VaultEcho snapshot @ $(date)"
          git push

      - name: ðŸ› ï¸ Wrangler Fallback Deploy (Optional)
        if: always() && env.CF_API_TOKEN != ''
        run: |
          npm install -g wrangler
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" > .env
          wrangler whoami || echo "Wrangler ready"
          wrangler publish || echo "Wrangler fallback skipped (optional)"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true
