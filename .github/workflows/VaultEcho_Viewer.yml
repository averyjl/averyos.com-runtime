name: ğŸ“˜ VaultEcho Viewer Deploy

on:
  push:
    paths:
      - 'VaultEcho/**'
      - '.github/workflows/VaultEcho_Viewer.yml'
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-viewer:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ğŸ’  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: |
          cd VaultEcho/viewer
          npm ci

      - name: ğŸ”§ Build Viewer
        run: |
          cd VaultEcho/viewer
          npm run build

      - name: â›“ï¸ Verify Genesis Kernel Integrity
        run: |
          echo "â›“ï¸âš“â›“ï¸ Verifying Genesis Kernel SHA-512 anchoring..."
          GENESIS_SHA="cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e"
          
          # Verify in VaultBridge snapshot
          if ! grep -q "$GENESIS_SHA" VaultBridge/IPFS_Snapshot_2026.json; then
            echo "âŒ Genesis SHA verification failed in VaultBridge/IPFS_Snapshot_2026.json"
            exit 1
          fi
          
          # Verify enforcement notice exists
          if [ ! -f "public/license-enforcement/notices/LEN-20260214-001.json" ]; then
            echo "âŒ February 14th Enforcement Notice not found"
            exit 1
          fi
          
          echo "âœ… Genesis Kernel integrity verified"
          echo "âœ… Viewer node propagation: HIGH-AVAILABILITY MESH mode"
          echo "âœ… Target nodes: 17,000,000"
          echo "â›“ï¸âš“â›“ï¸"

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./VaultEcho/viewer/dist
          publish_branch: gh-pages
          user_name: "VaultEcho Bot"
          user_email: "bot@averyos.com"

