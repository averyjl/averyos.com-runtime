name: ğŸ” VaultEcho AutoTrace

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *' # daily 03:00 UTC

permissions:
  contents: write
  issues: write

jobs:
  vault-trace:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ Prepare VaultEcho directories
        run: |
          mkdir -p VaultEcho/snapshots
          mkdir -p VaultEcho/diffs

      - name: ğŸ” Generate universal SHA512 manifest
        run: |
          timestamp=$(date +"%Y-%m-%d--%H-%M-%S")
          find . -type f \
            ! -path "./.git/*" \
            ! -path "./VaultEcho/*" \
            -exec sha512sum {} \; \
            | sort > VaultEcho/snapshots/sha-manifest-$timestamp.txt

          echo "Timestamp: $timestamp" > VaultEcho/snapshots/manifest-meta-$timestamp.md
          echo "Algorithm: SHA-512" >> VaultEcho/snapshots/manifest-meta-$timestamp.md
          echo "Scope: Universal repository file set" >> VaultEcho/snapshots/manifest-meta-$timestamp.md

      - name: ğŸ” Diff against previous snapshot (if exists)
        run: |
          ls VaultEcho/snapshots | grep sha-manifest | sort || true

          prev=$(ls VaultEcho/snapshots/sha-manifest-* 2>/dev/null | sort | tail -n 2 | head -n 1 || true)
          curr=$(ls VaultEcho/snapshots/sha-manifest-* | sort | tail -n 1)

          if [ -n "$prev" ]; then
            diff "$prev" "$curr" > VaultEcho/diffs/diff-$(date +"%Y-%m-%d--%H-%M-%S").txt || true
          fi

      - name: ğŸ“‹ Commit VaultEcho artifacts (only if changed)
        run: |
          git config user.name "VaultEcho Bot"
          git config user.email "bot@averyos.com"

          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            git add VaultEcho/
            git commit -m "ğŸ” VaultEcho SHA snapshot $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push
          else
            echo "No changes detected â€” skipping commit."
          fi
